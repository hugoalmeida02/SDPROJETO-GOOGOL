<!DOCTYPE html>
<html lang="pt">

<head>
  <meta charset="UTF-8" />
  <title>Googol</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>

<body>
  <header>
    <h1>Googol</h1>
  </header>

  <main>
    <form id="search-form" class="search-box">
      <input type="text" id="search-input" placeholder="Insere a palavra ou URL..." required />
      <select id="search-type">
        <option value="word">Pesquisa por palavra</option>
        <option value="backlinks">Pesquisa de backlinks</option>
        <option value="addurls">Adicionar url</option>
      </select>
      <button type="submit">Pesquisar</button>
    </form>

    <button id="open-stats-btn">Ver estatísticas</button>

    <div id="stats-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn" id="close-stats-btn">&times;</span>
        <h2>Estatísticas</h2>
        <div id="stats" class="stats-section"></div>
      </div>
    </div>

  </main>
  <script>document
  .getElementById("search-form")
  .addEventListener("submit", function (event) {
    event.preventDefault(); // evita recarregamento
    const query = document.getElementById("search-input").value.trim();
    const type = document.getElementById("search-type").value;

    const encoded = encodeURIComponent(query);
    console.log("Tipo selecionado:", type);
    if (type === "word") {
      window.location.href = `/search?words=${encoded}`;
    } else if (type === "backlinks") {
      window.location.href = `/search-backlinks?url=${encoded}`;
    } else if (type === "addurls") {
      fetch("/add-url", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
        },
        body: `url=${encoded}`,
      })
        .then((res) => res.json())
        .then((data) => {
          alert(data.message || data.error);
        })
        .catch((err) => {
          console.error("Erro ao adicionar URL:", err);
        });
    }
  });

// Abrir e fechar modal
document.getElementById("open-stats-btn").addEventListener("click", () => {
  document.getElementById("stats-modal").style.display = "block";
});

document.getElementById("close-stats-btn").addEventListener("click", () => {
  document.getElementById("stats-modal").style.display = "none";
});

// Fechar ao clicar fora do conteúdo do modal
window.addEventListener("click", function (event) {
  const modal = document.getElementById("stats-modal");
  if (event.target === modal) {
    modal.style.display = "none";
  }  
});
let socket = null;

function connect() {
  socket = new WebSocket("ws://" + window.location.host + "/websocket");

  socket.onopen = () => {
    console.log("Connected to plain WebSocket");
    // Recupera as estatísticas do localStorage, se existirem
    const savedStats = localStorage.getItem("stats");
    if (savedStats) {
      updateStats(JSON.parse(savedStats));
    }
  };

  socket.onmessage = (event) => {
    try {
      const data = JSON.parse(event.data);

      if (data.type === "stats") {
        updateStats(data);
      } else {
        console.log("Mensagem desconhecida:", data);
      }
    } catch (e) {
      console.error("Erro ao processar mensagem:", e);
    }
  };

  socket.onerror = (event) => {
    console.error("WebSocket error", event);
  };

  socket.onclose = () => {
    console.log("Disconnected from WebSocket");
  };
}

function updateStats(data) {
  const statsDiv = document.getElementById("stats");

  statsDiv.innerHTML = `
        <h3>Top 10 pesquisas</h3>
        <ul>${data.top_queries.map((q) => `<li>${q}</li>`).join("")}</ul>

        <h3>Barrels ativos</h3>
        <ul>${data.barrels
          .map(
            (b) => `<li>
                ${b.ip} - 
                Palavras indexadas: ${b.size_words} | 
                URLs indexados: ${b.size_urls}
            </li>`
          )
          .join("")}</ul>

        <h3>Tempo médio de resposta (décimas de segundo)</h3>
        <ul>${Object.entries(data.avg_response_times)
          .map(([ip, t]) => `<li>${ip}: ${t.toFixed(4)}</li>`)
          .join("")}</ul>
    `;

  // Salvar as estatísticas no localStorage
  localStorage.setItem("stats", JSON.stringify(data));
}

window.addEventListener("load", () => {
  connect(); // Estabelece ligação ao WebSocket para stats
});
</script>
  <script src="/static/websocket.js" defer></script>
</body>

</html>